!function(t){"use strict";t.widget("directEdit.directImageEditor",{dialog:null,image:null,isImage:!0,callback:null,textEditor:null,additionalData:{},options:{selector:"img",ajaxUrl:"",constraints:{minWidth:16,maxWidth:800,minHeight:16,maxHeight:600},dialogOptions:{width:"600",height:"500",title:"Edit image",modal:!1,position:["center","middle"],resizable:!1,draggable:!0,dialogClass:"direct-edit"},uploadCommand:["action","direct-upload-image"],editCommand:["action","direct-edit-image"],scaleType:"normal"},_create:function(){var e,i,n,a,o;o=this,this.element.is("img")?(this.isImage=!0,this.image=this.element,this.imageData=this.getImageData(),this.options.modified&&(this.modified=!0)):(this.isImage=!1,this.textEditor=this.element.data("directEdit-directTextEditor")),this.options.dialogOptions.autoOpen=!1,this.options.dialogOptions.minWidth=this.options.dialogOptions.width,this.dialog=t('<div id="direct-image-editor-dialog"></div>').dialog(this.options.dialogOptions),o.dialog.parent().css({"min-width":o.options.dialogOptions.width+"px"}),function(){var s;e=function(e){o.isImage?(s=t(e.target).addClass("direct-image-editor-active-image"),i(s)):t(e.target).is(o.options.selector)?(o.image=s=t(e.target).addClass("direct-image-editor-active-image"),i(o.image),o.imageData=o.getImageData(),o.setAdditionalData(t.directEdit.fn.getData(o.image))):(o.image=null,o.imageData={},o.setAdditionalData())},n=function(e){t(e.target).is(o.options.selector)&&o.dialog.dialog("open")},a=function(){o.imageData.source?o._createEditPage():o._createUploadPage()},i=function(e){var i;i=function(n){n.target!==e[0]&&(e.removeClass("direct-image-editor-active-image"),t(document).off("mousedown",i))},t(document).on("mousedown",i)}}(),this._createSuccessHandler(),this.element.mousedown(e),this.element.dblclick(n),this.dialog.on("dialogopen",a)},_createSuccessHandler:function(){var t=this;this.callback=function(e){t.options.callback?(e=e||{},t.options.callback.call(t,e)):t.image&&t.cloneImageAttributes(e.content)}},getDialog:function(){return this.dialog},_createEditPage:function(){function e(t,e){return'<div class="select_image_type"><input type="radio" name="image_style" value="'+t+'" class="select_image_style" id="select_image_style_'+t+'"'+(e?' checked="checked"':"")+' /><label for="select_image_style_'+t+'" class="'+t+'" title="'+t+'"></label></div>'}var i,n,a,o,s,r,d,l,c,h,u,p,m,g,f,v,b,x;if(a=this.options.styles,a||(a={},a.single={constraints:this.options.constraints}),x=this,i=this.imageData.style,void 0===i||void 0===a[i]){o=!0;for(n in a)a.hasOwnProperty(n)&&(o||a[n].isDefault)&&(i=n,this.imageData.style=n,o=!1)}if(r="",Object.keys(a).length>1)for(n in a)a.hasOwnProperty(n)&&(r+=e(n,i===n));s=t('<div id="direct-image-editor-dialog-editpage">'),h=t('<div class="toolbox">').appendTo(s),u=t('<form action="" id="selfForm" method="post">').appendTo(h),u.append('<input type="hidden" name="image_class" id="image_class" value="inline" />'),u.append(r),u.append('<div class="spinner">'+directTranslate("Uploading in the background.")+"</div>"),u.append('<div class="input_text"><label for="alt">alt:</label><input type="text" name="alt" id="alt" value="'+(this.imageData.alt||"")+'" /></div>'),p=t('<div class="buttonset"><input type="button" id="imageReset" value="'+directTranslate("Different image")+'" /><input type="button" id="sendForm" value="'+directTranslate("Save")+'"></div>'),p.buttonset().appendTo(u),l=t('<div class="sliderContainer">').appendTo(h),m=t('<div id="fixed-size-wrapper" style="width:'+a[i].constraints.maxWidth+"px;height:"+a[i].constraints.maxHeight+'px">'),m.appendTo(s),d=t('<div class="editableImage" style="overflow:hidden; width:'+(this.imageData.containerW||"0")+"px; height:"+(this.imageData.containerH||"0")+'px;"><img src="'+this.imageData.source+'" style="position:relative; top:'+(this.imageData.top||"0")+"px; left:"+(this.imageData.left||"0")+"px; width:"+(this.imageData.imageScaledW||"0")+"px; height:"+(this.imageData.imageScaledH||"0")+'px;" alt="" /></div>'),d.appendTo(m),c={sliderContainer:l},this.options.scaleType&&t.extend(c,{scaleType:this.options.scaleType}),this.options.sourceMaxResize&&t.extend(c,{sourceMaxResize:this.options.sourceMaxResize}),this.imageData.imageScaledW&&this.imageData.imageScaledH||t.extend(c,{resetSize:!0}),t.extend(c,a[i].constraints),d.directImageEditorCPS(c),function(){g=function(){x.imageData.style=t(this).attr("value"),d.directImageEditorCPS(a[x.imageData.style].constraints),m.width(a[x.imageData.style].constraints.maxWidth).height(a[x.imageData.style].constraints.maxHeight),x.repositionDialog()},f=function(t){t.stopPropagation(),x._createUploadPage()},v=function(){var e={data:{}};t.extend(e.data,x.additionalData,d.directImageEditorCPS("getState")),e.data.style=x.imageData.style,e.data.alt=s.find("input#alt").val(),e[x.options.editCommand[0]]=x.options.editCommand[1],x.saveImageData(e,x.callback),x.dialog.dialog("close"),x.modified=!0},b=function(e){e.data&&t.extend(x.additionalData,e.data),s.find("#sendForm").button("enable"),t(".spinner",s).css("opacity",0)}}(),s.find("input.select_image_style").change(g),s.find("#imageReset").click(f),s.find("#sendForm").click(v),this.imageData.file&&(t(".spinner",s).show(),s.find("#sendForm").button("disable"),this.saveSourceImage(this.additionalData,this.imageData.file,b)),this.dialog.empty().append(s),this.repositionDialog()},_createUploadPage:function(){var e,i,n;n=this,e=t('<div><form><input type="file" name="file" /></form></div>'),e.find(":file").change(function(){var a,o;a=this.files[0],a.type.match("image.*")&&(FileReader?(o=new FileReader,o.onload=function(t){return function(e){var i;i=e.target.result,n._createConfirmPage(i,t)}}(a),o.onerror=function(){directNotify(directTranslate("Error reading image."))},o.readAsDataURL(a)):(i=function(e){e.data&&t.extend(n.additionalData,e.data),e.url&&(n.imageData.source=e.url),n._createEditPage()},t('<div id="spinner"></div>').appendTo(e).show(),n.saveSourceImage(n.additionalData,a,i)))}),this.dialog.empty().append(e),this.repositionDialog(this.options.dialogOptions.width,this.options.dialogOptions.height)},_createConfirmPage:function(e,i){function n(t){if("normal"===o.options.scaleType){if(o.options.constraints.minWidth&&t.width()<o.options.constraints.minWidth||o.options.constraints.minHeight&&t.height()<o.options.constraints.minHeight)return a.append("<p>The image is too small, it should be "+o.options.constraints.minWidth+"px x "+o.options.constraints.minHeight+"px, and it is "+t.width()+"px x "+t.height()+"px</p>"),!1}else if(o.options.constraints.minWidth&&t.width()<o.options.constraints.minWidth&&o.options.constraints.minHeight&&t.height()<o.options.constraints.minHeight)return o.options.constraints.minWidth&&t.width()<o.options.constraints.minWidth&&a.append("<p>"+directTranslate("The image width is too small, it should be")+" "+o.options.constraints.minWidth+"px"+directTranslate("and it is")+" "+t.width()+"px.</p>"),o.options.constraints.minHeight&&t.height()<o.options.constraints.minHeight&&a.append("<p>"+directTranslate("The image height is too small, it should be")+" "+o.options.constraints.minHeight+"px"+directTranslate("and it is")+" "+t.height()+"px.</p>"),!1;return!0}var a,o,s,r;o=this,a=t('<div><div id="imageUploadButtons"></div><div id="imageThumb" style="margin-top:10px;"></div></div>'),s=t("<img>"),s.hide(),a.find("#imageThumb").append(s),r=function(){var r=a.find("#imageUploadButtons");t('<input type="button" id="imageReset" value="'+directTranslate("Different image")+'" />').appendTo(r).click(function(t){t.stopPropagation(),o._createUploadPage()}),n(s)&&(s.css("maxWidth",360),s.show(),t('<input type="button" id="imageUploadButton" value="'+directTranslate("Upload and edit")+' >>" />').appendTo(r).click(function(t){t.stopPropagation(),o.imageData={},o.imageData.source=e,o.imageData.alt=i.name.split(".")[0],o.imageData.file=i,o._createEditPage()})),r.buttonset()},s.on("load",function(){r()}),s.attr("src",e),this.dialog.empty().append(a)},saveSourceImage:function(e,i,n){var a,o=new FormData;o.append("file",i),o.append(this.options.uploadCommand[0],this.options.uploadCommand[1]);for(a in e)e.hasOwnProperty(a)&&"file"!==a&&o.append("data["+a+"]",e[a].toString());t.ajax({url:this.options.ajaxUrl||t.directEdit.fn.ajaxUrl,type:"POST",xhr:function(){var e=t.ajaxSettings.xhr();return e},error:function(){window.alert(directTranslate("Image uploading failed.")),t("#direct-image-editor-dialog-editpage .spinner").hide()},success:n,data:o,dataType:"json",cache:!1,contentType:!1,processData:!1})},saveImageData:function(e,i){t.ajax({url:this.options.ajaxUrl||t.directEdit.fn.ajaxUrl,type:"POST",error:function(){window.alert(directTranslate("Modifications could not be saved."))},dataType:"json",success:i,data:e})},repositionDialog:function(t,e){var i=this;setTimeout(function(){i.dialog.parent().addClass("transition"),i.dialog.dialog({position:{my:"center",at:"center"},width:t||"auto",height:e||"auto"})},10),setTimeout(function(){i.dialog.parent().removeClass("transition")},20)},isModified:function(){return this.modified||!1},setModified:function(){this.modified=!0},cloneImageAttributes:function(e){var i,n;n=this,i=t(e),t.each(i.get(0).attributes,function(t,e){n.image.attr(e.nodeName,e.value)}),this.imageData=this.getImageData(),this.setAdditionalData(t.directEdit.fn.getData(this.image))},getImageData:function(){var t,e,i,n;e=["containerW","containerH","imageScaledH","imageScaledW","top","left","source","style"],n={};for(t in e)e.hasOwnProperty(t)&&(i=this.image.attr("data-"+[e[t].toLowerCase()]),i&&(n[e[t]]=i));return i=this.image.attr("alt"),i&&(n.alt=i),n},getData:function(){return this.image?{content:this.image[0].outerHTML,data:this.additionalData}:void 0},setData:function(t){this.isImage&&(this.cloneImageAttributes(t.content),this.modified=!1)},setAdditionalData:function(e){this.additionalData={},this.textEditor&&t.extend(this.additionalData,this.textEditor.additionalData),t.extend(this.additionalData,e)}}),t.widget("directEdit.directImageEditorCPS",{imageScaledW:0,imageScaledH:0,imageSrcW:0,imageSrcH:0,relativeX:.5,relativeY:.5,containerW:0,containerH:0,container:null,image:null,slider:null,options:{minWidth:100,minHeight:70,maxWidth:1200,maxHeight:1200,handles:"e, s, se",autoHide:!0,sliderContainer:null,scaleType:"normal"},_create:function(){var e,i,n,a,o;if(e=this.container=this.element,i=this.image=e.children("img"),!e.is("div")||1!==i.length)throw"directImageEditorCPS must be applied on a div containing a single img.";e.addClass("image-editor-container"),this.slider=t('<div class="image-editor-slider" />'),this.options.sliderContainer?this.options.sliderContainer.append(this.slider):(i.after(this.slider),this.slider.wrap('<div class="ui-slider-container"/>')),n=i.attr("src"),a=t("<img>"),a.hide(),o=this,e.append(a),a.on("load",function(){o._fetchSourceSize(a)}),a.attr("src",n)},_init:function(){(0!==this.imageSrcW||0!==this.imageSrcH)&&(this.container.resizable("destroy"),this.container.off("hover"),this.container.children().show(),this.options.resetSize=!0,this._initialize())},_fetchSourceSize:function(t){if(0===t.width()||0===t.height())throw"Could not fetch image size";var e=this.options.sourceMaxResize?this.options.sourceMaxResize/Math.max(t.width(),t.height()):1;this.imageSrcW=t.width()*e,this.imageSrcH=t.height()*e,t.remove(),this._initialize()},_initialize:function(){var t,e,i,n,a,o,s,r,d;if(0===this.imageSrcW||0===this.imageSrcH)throw"Could not detect image size";t=this,e=this.container,i=this.image,"fit"!==this.options.scaleType&&(this.options.maxWidth=Math.min(this.options.maxWidth,this.imageSrcW),this.options.maxHeight=Math.min(this.options.maxHeight,this.imageSrcH)),this.options.minWidth=Math.min(this.options.minWidth,this.options.maxWidth),this.options.minHeight=Math.min(this.options.minHeight,this.options.maxHeight),n=this.options.resetSize?this._resetSize():this._getSizeFromImage(i,e),e.resizable({start:function(){a=Math.max(t.imageScaledW/t.imageSrcW,t.imageScaledH/t.imageSrcH)},resize:function(e,i){var n,o,s,r;t.containerW=i.size.width,t.containerH=i.size.height,n=t.containerW/t.imageSrcW,o=t.containerH/t.imageSrcH,s="fit"===t.options.scaleType?Math.min(Math.min(n,o),1):Math.max(n,o),r=Math.max(s,a),t.imageScaledW=t.imageSrcW*r,t.imageScaledH=t.imageSrcH*r,t._setSlider(r),t._updateView()},maxWidth:t.options.maxWidth,maxHeight:t.options.maxHeight,minWidth:t.options.minWidth,minHeight:t.options.minHeight,handles:t._getHandles()}),i.draggable({start:function(){o=t._getContainment()},drag:function(t,e){e.position.left<o.minX&&(e.position.left=o.minX),e.position.left>o.maxX&&(e.position.left=o.maxX),e.position.top<o.minY&&(e.position.top=o.minY),e.position.top>o.maxY&&(e.position.top=o.maxY)},stop:function(e,i){t.relativeX=t.containerW-t.imageScaledW!==0?i.position.left/(t.containerW-t.imageScaledW):t.relativeX,t.relativeY=t.containerH-t.imageScaledH!==0?i.position.top/(t.containerH-t.imageScaledH):t.relativeY}}),this.slider.slider({values:[0],max:1e3,start:function(){s=t.containerW,r=t.containerH},slide:function(e,i){var n,a,o;n=t._getScaleMin(),a=Math.max(0,Math.min(i.value/1e3,1)),o=n+(1-n)*a,t.imageScaledW=t.imageSrcW*o,t.imageScaledH=t.imageSrcH*o,"fit"!==t.options.scaleType&&(t.containerW=Math.min(s,t.imageScaledW),t.containerH=Math.min(r,t.imageScaledH)),t._updateView()}}),this.options.autoHide&&(d=e.children().not("img").hide(),e.hover(function(){d.stop(!0,!0).fadeIn(300)},function(){d.stop(!0,!0).delay(2e3).fadeOut(300)})),i.css({position:"absolute",cursor:"move","min-width":0,"min-height":0,"max-width":"none","max-height":"none",border:"none",padding:"0",margin:"0"}),e.css({overflow:"hidden"}),this._updateView(),this._setSlider(n)},_getSizeFromImage:function(t,e){var i,n,a,o;return this.imageScaledW=t.width(),this.imageScaledH=t.height(),this.containerW=e.width(),this.containerH=e.height(),i=this.containerW-this.imageScaledW,n=this.containerH-this.imageScaledH,this.relativeX=0!==i?parseInt(t.css("left"),10)/i:this.relativeX,this.relativeY=0!==n?parseInt(t.css("top"),10)/n:this.relativeY,this.relativeX=Math.min(1,Math.max(0,this.relativeX)),this.relativeY=Math.min(1,Math.max(0,this.relativeY)),a=Math.max(this.imageScaledW/this.imageSrcW,this.imageScaledH/this.imageSrcH),o=this._getScaleMin(),a=Math.min(Math.max(a,o),1),this.imageScaledW=this.imageSrcW*a,this.imageScaledH=this.imageSrcH*a,this.containerW=Math.max(Math.min(this.containerW,this.options.maxWidth),this.options.minWidth),this.containerH=Math.max(Math.min(this.containerH,this.options.maxHeight),this.options.minHeight),a},_resetSize:function(){var t,e;return this.relativeX=.5,this.relativeY=0,t=Math.min(this.options.maxWidth/this.imageSrcW,this.options.maxHeight/this.imageSrcH),e=this._getScaleMin(),t=Math.min(Math.max(t,e),1),this.containerW=this.imageSrcW*t,this.containerH=this.imageSrcH*t,this.imageScaledW=this.imageSrcW*t,this.imageScaledH=this.imageSrcH*t,this.containerW=Math.max(Math.min(this.containerW,this.options.maxWidth),this.options.minWidth),this.containerH=Math.max(Math.min(this.containerH,this.options.maxHeight),this.options.minHeight),t},_updateView:function(){var t,e;this.image.css("width",this.imageScaledW),this.image.css("height",this.imageScaledH),this.container.css("width",this.containerW),this.container.css("height",this.containerH),t=(this.containerW-this.imageScaledW)*this.relativeX,e=(this.containerH-this.imageScaledH)*this.relativeY,this.image.css("left",t+"px"),this.image.css("top",e+"px")},_getScaleMin:function(){var t;return t="fit"===this.options.scaleType?Math.min(this.options.minWidth/this.imageSrcW,this.options.minHeight/this.imageSrcH):Math.max(this.options.minWidth/this.imageSrcW,this.options.minHeight/this.imageSrcH)},_setSlider:function(t){var e,i;e=this._getScaleMin(),i=1e3*(t-e)/(1-e),this.slider.slider("values",0,i)},_getContainment:function(){var t=[];return t.minX=Math.min(this.containerW-this.imageScaledW,0),t.minY=Math.min(this.containerH-this.imageScaledH,0),t.maxX=Math.max(this.containerW-this.imageScaledW,0),t.maxY=Math.max(this.containerH-this.imageScaledH,0),t},_getHandles:function(){var t,e,i,n=[],a=[];for(this.options.maxWidth>this.options.minWidth&&a.push("e","w"),this.options.maxHeight>this.options.minHeight&&a.push("n","s"),(this.options.maxWidth>this.options.minWidth||this.options.maxHeight>this.options.minHeight)&&a.push("ne","se","sw","nw"),i=this.options.handles.split(","),t=0;t<i.length;t+=1)for(i[t]=i[t].replace(/^\s\s*/,"").replace(/\s\s*$/,""),e=0;e<a.length;e+=1)a[e]===i[t]&&n.push(a[e]);return 0===n.length&&n.push("X"),n.join()},getState:function(){return{imageScaledW:Math.round(this.imageScaledW),imageScaledH:Math.round(this.imageScaledH),left:Math.round(this.relativeX*(this.containerW-this.imageScaledW)),top:Math.round(this.relativeY*(this.containerH-this.imageScaledH)),containerW:Math.round(this.containerW),containerH:Math.round(this.containerH)}}})}(jQuery),function(t){"use strict";t.widget("directEdit.directFileUploader",{dialog:null,callback:null,additionalData:{},options:{ajaxUrl:"",dialogOptions:{width:540,height:95,title:"Upload file",modal:!1,resizable:!1,draggable:!1,autoOpen:!1,dialogClass:"direct-edit"},followButtonText:"open",editButtonText:"upload",uploadCommand:["action","direct-upload-file"]},_create:function(){var e,i,n;i=this,this.element.is("a")&&(this.element.addClass("direct-file-uploader"),t.directEdit.directManager&&(this.instanceID=t.directEdit.directManager.register(this,this.element.attr("id"))),this.originalUrl=this.url=this.element.attr("href"),n=t('<div class="direct-file-uploader-buttons">'),this.follow=t('<a target="_blank">'+this.options.followButtonText+"</a>").attr("href",this.url).appendTo(n),t('<a href="">'+this.options.editButtonText+"</a>").appendTo(n).click(function(){return i.dialog.dialog("open"),!1}),this.element.removeAttr("href").addClass("link-editor").prepend(n)),this.dialog=t('<div id="direct-file-uploader-dialog"></div>').dialog(this.options.dialogOptions),function(){e=function(){var t;t=i.element.data("directEdit-directTextEditor"),i.additionalData=t.additionalData,console.log(i.additionalData),i._createUploadPage()}}(),this.dialog.on("dialogopen",e)},isModified:function(){return this.url!==this.originalUrl},getData:function(){return{data:this.additionalData,url:this.url}},setData:function(e,i){e.url&&(this.url=e.url),this.follow&&this.follow.attr("href",this.url),i||(this.originalUrl=this.url),t.extend(this.additionalData,e.data)},setAdditionalData:function(t){this.additionalData=t},getDialog:function(){return this.dialog},_createUploadPage:function(){var e,i,n;n=this,function(){i=function(t){n.dialog.dialog("close"),n.options.callback&&t?n.options.callback.call(n,t):n.setData(t,!0)}}(),e=t('<div><form><input type="file" name="file" /></form></div>'),e.find(":file").change(function(){var a,o;a=this.files[0],o=t("#spinner",e).show(),n.saveFile(n.additionalData,a,i)}),this.dialog.empty().append(e)},saveFile:function(e,i,n){var a,o=new FormData;o.append("file",i),o.append(this.options.uploadCommand[0],this.options.uploadCommand[1]);for(a in e)e.hasOwnProperty(a)&&"file"!==a&&o.append("data["+a+"]",e[a].toString());t.ajax({url:this.options.ajaxUrl||t.directEdit.fn.ajaxUrl,type:"POST",xhr:function(){var e=t.ajaxSettings.xhr();return e},error:function(){window.alert("Kan bestand niet uploaden")},success:n,data:o,dataType:"json",cache:!1,contentType:!1,processData:!1})}})}(jQuery),function(t){"use strict";t.widget("directEdit.directTextEditor",{toolbar:null,state:"inactive",hasPlaceholderContent:!1,eventHandlers:null,selection:null,originalValidatedContent:"",originalValidatedContentSet:!1,additionalData:null,options:{debug:!1,validate:!1,instanceID:0,format:"block",placeholder:"empty",formatRules:{div:"h1,h2,h3,h4,p,blockquote,ol,ul",p:"b,i,a,br,img",ul:"li",ol:"li",li:"b,i,a,br",blockquote:"b,i,a,br"}},_create:function(){return("plain"===this.options.format||"title"===this.options.format)&&(this._validateContent=this._validateContentPlain),this._createEventHandlers(),this.options.buttons&&this._createToolbar(),this.originalContent=this.element.html(),this.tagName=this.element.get(0).tagName.toLowerCase(),this.element.attr("contentEditable",!0),document.execCommand("enableObjectResizing",!1,"false"),this._styleWithCSS(),this.enabled||(this.element.bind("focus",this.eventHandlers.focusOnText).bind("blur",this.eventHandlers.blurOnText).bind("keydown",this.eventHandlers.keyDown).bind("mouseup",this.eventHandlers.storeSelection).bind("change paste drop",this.eventHandlers.change).bind("changedelayed pastedelayed dropdelayed",this.eventHandlers.validateContent),this.enabled=!0),this._setPlaceholder(!0),this},_destroy:function(){this.toolbar.remove(),this._setPlaceholder(!1),this.element.unbind("focus",this.eventHandlers.focusOnText).unbind("blur",this.eventHandlers.blurOnText).unbind("keydown",this.eventHandlers.keyDown).unbind("mouseup",this.eventHandlers.storeSelection).unbind("change paste drop",this.eventHandlers.change).unbind("changedelayed pastedelayed dropdelayed",this.eventHandlers.validateContent),this.element.attr("contentEditable",!1),t.Widget.prototype.destroy.call(this)},activate:function(){t(this.element).addClass("inEditMode"),this._validateContent(),this.originalValidatedContentSet||(this.originalValidatedContent=this.element.html(),this.originalValidatedContentSet=!0),this.toolbar&&this.toolbar.show(),this._setPlaceholder(!1),this._trigger("activated",this)},deactivate:function(){this.element[0].setSelectionRange&&this.element[0].setSelectionRange(0,0),t(this.element).removeClass("inEditMode"),this.toolbar&&this.toolbar.hide(),this._setPlaceholder(!0),this._trigger("deactivated",this)},_setPlaceholder:function(t){if(t)/^((<br\s?\/?>|<p>|<\/p>|\s|&nbsp;)*)$/.test(this.element.html())&&(this.element.html(this.options.placeholder),"block"===this.options.format&&this.element.contents().wrap("<p>"),this.hasPlaceholderContent=!0);else if(this.hasPlaceholderContent)if(this.hasPlaceholderContent=!1,"block"===this.options.format){var e=this.element.find("p").html("&nbsp;"),i=document.createRange();i.selectNode(e.get(0))}else this.element.html("&nbsp;")},isTouched:function(){return this.originalContent!==this.element.html()||this.isModified()},isModified:function(){var t;return t=this.originalValidatedContentSet?this.hasPlaceholderContent?""!==this.originalValidatedContent:this.originalValidatedContent!==this.element.html():!1},getData:function(){var t={};return this._validateContent(),t.content=this.hasPlaceholderContent?"":this.element.html(),t.data=this.additionalData,t},setData:function(e){this.element.html(e.content),t.extend(this.additionalData,e.data),this.originalValidatedContent=this.originalContent=this.element.html(),this.hasPlaceholderContent=!1,this._setPlaceholder(!0)},setAdditionalData:function(t){this.additionalData=t},_styleWithCSS:function(){try{return document.execCommand("styleWithCSS",0,!1)}catch(t){try{return document.execCommand("useCSS",0,!0)}catch(e){try{return document.execCommand("styleWithCSS",!1,!1)}catch(i){}}}},_createEventHandlers:function(){var e=this;this.eventHandlers={focusOnText:function(){switch(e.state){case"inactive":e.activate(),e.state="active",e.options.debug&&console.log("focusOnText: inactive -> active");break;case"active":break;case"pluginHasFocus":e.options.debug&&console.log("focusOnText: pluginHasFocus -> active"),e.state="active";break;default:e.options.debug&&console.log("Unforeseen situation focusOnText while "+e.state)}},blurOnText:function(){switch(e.state){case"active":e.deactivate(),e.state="inactive",e.options.debug&&console.log("blurOnText: active -> inactive");break;case"mouseActiveOnToolbar":case"pluginHasFocus":e.options.debug&&console.log("blurOnText: "+e.state+" -> "+e.state);break;default:e.options.debug&&console.log("Unforeseen situation blurOnText while "+e.state)}},toolbarMouseDown:function(t){switch(e.state){case"active":t.preventDefault(),e.options.debug&&console.log("preventDefault mouseDown on Toolbar");break;case"pluginHasFocus":break;default:e.options.debug&&console.log("Unforeseen situation toolbarMouseDown while "+e.state)}},toolbarMouseUp:function(){switch(e.state){case"active":e.state="mouseActiveOnToolbar",e.options.debug&&console.log("toolbarMouseUp: active -> mouseActiveOnToolbar"),setTimeout(e.eventHandlers.toolbarMouseReset,100);break;case"pluginHasFocus":e.state="toolbarWhilePluginActive",e.options.debug&&console.log("toolbarMouseUp: pluginHasFocus -> toolbarWhilePluginActive");break;default:e.options.debug&&console.log("Unforeseen situation toolbarMouseUp while "+e.state)}},toolbarMouseReset:function(){switch(e.state){case"mouseActiveOnToolbar":e.state="active",e.options.debug&&console.log("toolbarMouseReset: mouseActiveOnToolbar -> active");break;case"pluginHasFocus":case"active":break;default:e.options.debug&&console.log("Unforeseen situation toolbarMouseReset while "+e.state)}},pluginTakesFocus:function(){switch(e.state){case"toolbarWhilePluginActive":e.options.debug&&console.log("pluginTakesFocus: "+e.state+" -> pluginHasFocus");break;default:e.options.debug&&console.log("pluginTakesFocus: "+e.state+" -> pluginHasFocus"),e.eventHandlers.restoreSelection(),e.state="pluginHasFocus"}},pluginReturnsFocus:function(){switch(e.state){case"pluginHasFocus":e.state="active",e.element.focus(),e.options.debug&&console.log("pluginReturnsFocus: pluginHasFocus -> active");break;case"active":case"inactive":break;case"toolbarWhilePluginActive":e.state="mouseActiveOnToolbar",e.options.debug&&console.log("pluginReturnsFocus: toolbarWhilePluginActive -> mouseActiveOnToolbar");break;default:e.options.debug&&console.log("Unforeseen situation pluginReturnsFocus while "+e.state)}},pluginDialogBlur:function(){switch(e.state){case"active":break;case"toolbarWhilePluginActive":e.state="active",e.element.focus(),e.options.debug&&console.log("pluginDialogBlur: toolbarWhilePluginActive -> active");break;case"pluginHasFocus":e.deactivate(),e.state="inactive",e.options.debug&&console.log("pluginDialogBlur: pluginHasFocus -> inactive");break;default:e.options.debug&&console.log("Unforeseen situation pluginDialogBlur while "+e.state)}},keyDown:function(t){switch(e.state){case"pluginHasFocus":break;default:13===t.keyCode?"block"!==e.options.format&&(t.preventDefault(),"title"!==e.options.format&&(document.execCommand("inserthtml",!1,"<br/>#"),document.execCommand("delete",!1))):27===t.keyCode&&(e.options.debug&&console.log("escape pressed"),e.element.blur())}},change:function(t){var i=t.type+"delayed";window.setTimeout(function(){e.element.trigger(i)},10)},validateContent:function(t){("keyup"!==t.type||13===t.keyCode)&&e._validateContent()},storeSelection:function(i){var n;t(i.target).is("img")&&(n=document.createRange(),n.selectNode(i.target),window.getSelection().removeAllRanges(),window.getSelection().addRange(n)),window.getSelection().rangeCount&&(e.lastSelection=window.getSelection().getRangeAt(0))},restoreSelection:function(){var t=window.getSelection();t.removeAllRanges(),t.addRange(e.lastSelection)}}},_validateContent:function(e,i){var n,a,o=this,s="";if(this.options.validate){if(e||(e=this.element,i="block"===this.options.format?"div":"p"),"plaintext"===i)return s=e.text().replace(/\s+/g," "),e.html()!==s&&e.html(s),void 0;if(e.is("p")&&(a=e.contents(),n=a[a.length-1],n&&n.tagName&&"br"==n.tagName.toLowerCase()&&n.parentNode.removeChild(n)),e!=this.element&&"img"!==e.prop("nodeName").toLowerCase()&&e.removeAttr("style"),e.contents().each(function(){var n,a,s,r,d;n=this,a=t(this),a.hasClass("noValidate")||(3!==n.nodeType&&a.is(o.options.formatRules[i])?(s=i===o.tagName&&"p"!==i?"plaintext":i,r=n.tagName.toLowerCase(),d=o.options.formatRules[r]?r:s,o._validateContent(a,d)):i===o.tagName&&"p"!==i?""!==a.text().trim()||a.is("img")?(a.wrap("<p />"),o._validateContent(a.parent(),"p")):a.remove():3!==n.nodeType?"p"===e.get(0).tagName.toLowerCase()&&a.is(o.options.formatRules[o.tagName])||(""===a.text().trim()?a.remove():(o._validateContent(a,i),a.contents().unwrap())):("ul"===i||"ol"===i)&&a.wrap("<li />"))}),e===this.element&&!e.is("p")){var r=this.element.find("p");r.length>1&&t(r.get().reverse()).each(function(){var e,i=t(this);0===i.contents().length&&i.remove(),1===i.contents().length&&1==i.children("img").length&&i.next().is("p")&&(e=i.children("img"),console.log("image moved to start of paragraph"),i.next().prepend(e),i.remove())})}}},_validateContentPlain:function(){var e,i,n,a=this;n=function(e){var i="",o="";return e.contents().each(function(){i+=o,o="",3!==this.nodeType?"br"===this.tagName.toLowerCase()?o="title"===a.options.format?" ":"<br>":i+=n(t(this)):i+=this.textContent}),i},i=n(this.element).replace(/\s{2,}/g," "),e=this.element.html().replace(/\&nbsp;/g," ").replace(/\s{2,}/g," "),e!==i&&(this.element.html(i),window.getSelection().removeAllRanges())},_createButton:function(e){var i,n,a,o,s,r,d,l,c,h,u,p;return this.buttonDefinitions.hasOwnProperty(e)?(p=this.buttonDefinitions[e],o=String("directEdit-textEditor-button-"+this.options.instanceID+"-"+e),a=t('<span><label for="'+o+'" title="'+p.tooltip+'">'+p.buttontext+"</label></span>"),i=t('<input id="'+o+'" type="checkbox" />').appendTo(a),n=p.buttonOptions||{},p.icon&&(n.icons={primary:p.icon},n.text=null),t.fn.button.noConflict&&(t.fn.btn=t.fn.button.noConflict()),i.button(n),function(e,n){s=function(){n.next("label").removeClass("ui-state-active"),t(document).unbind("mouseup",s)},r=function(){n.next("label").addClass("ui-state-active"),t(document).bind("mouseup",s)},d=function(){n.attr("checked",!1),n.button("refresh")},l=function(){n.prev("label").click()},"function"==typeof p.createDialog?(c=p.createDialog.call(e,i),h=function(){c.dialog("open")},e._registerDialog(c)):"function"==typeof p.command?h=function(){e.eventHandlers.pluginTakesFocus(),p.command.call(e,n),e.eventHandlers.pluginReturnsFocus(),e.element.trigger("change")}:"string"==typeof p.command&&(h=function(){e.eventHandlers.pluginTakesFocus();try{"formatBlock"===p.command&&document.execCommand("outdent",!1,""),document.execCommand(p.command,!1,p.commandValue)}catch(t){}e.eventHandlers.pluginReturnsFocus(),e.element.trigger("change")}),u="function"==typeof p.queryState?function(){n.attr("checked",p.queryState.call(e)),n.button("refresh")}:p.queryState!==!1&&"string"==typeof p.command?function(){var t;try{t="formatBlock"===p.command?document.queryCommandValue("formatBlock").toUpperCase()===p.commandValue:document.queryCommandState(p.command),n.attr("checked",t),n.button("refresh")}catch(e){}}:null}(this,i),i.prev("label").dblclick(l),i.prev("label").mousedown(this.eventHandlers.storeSelection),i.bind("change",h),u?this.element.bind("keyup paste change mouseup",u):(i.next("label").bind("mousedown",r),i.change(d)),a):""},_createToolbar:function(){var e,i,n;i=t("#direct-text-editor-toolbar-container"),0===i.length&&(i=t('<div id="direct-text-editor-toolbar-container" class="direct-edit">'),i.css("position","fixed"),i.draggable({cancel:"label",scroll:!1}),t("body").append(i)),this.toolbar=e=t('<div class="toolbar"><div class="grip"></div></div>').hide(),i.append(e),e.bind("mousedown",this.eventHandlers.toolbarMouseDown),e.bind("mouseup",this.eventHandlers.toolbarMouseUp),n=function(e){var i,a,o;if("string"==typeof e)return this._createButton(e);a=!0,o=t();for(i in e)e.hasOwnProperty(i)&&(i=e[i],"object"==typeof i&&(a=!1),o=o.add(n.call(this,i)));return a&&(o=t("<span></span>").append(o).buttonset()),o},e.append(n.call(this,this.options.buttons))},_registerDialog:function(e){var i,n;i=this,n=function(e,n){return function(a){t.contains(n.dialog("widget")[0],a.target)||(e.eventHandlers.pluginTakesFocus(),i.options.debug&&console.log("pseudo blur on dialog, close dialog"),n.dialog("close"))}}(this,e),e.dialog("option","focus",function(){setTimeout(function(){t(document).bind("click",n)},20),i.eventHandlers.pluginTakesFocus()}),e.dialog("option","close",function(){t(document).unbind("click",n),i.eventHandlers.pluginReturnsFocus()
})}})}(jQuery),function(t){"use strict";t.widget("directEdit.directListEditor",{additionalData:null,ajaxUrl:"",options:{ajaxUrl:"",init:null,listSelector:"",placeholder:"<a>add first item</a>",callback:null,command:["action","direct-"]},_create:function(){this.element.attr("data-definition")&&(this.definition=JSON.parse(this.element.attr("data-definition"))),this.items={}},_init:function(){var e,i,n,a,o;e=this,this.element.find(".direct-list-editor-buttons").remove(),this.list=e.options.listSelector&&this.element.is(e.options.listSelector)||1!==this.element.find(e.options.listSelector).length?this.element:this.element.find(e.options.listSelector),n=this.list.children(),i=t(n).length,a=function(t,n){var a;return e.options.commands[t].showOn&&(a=1===i?"single":0===n?"first":n===i-1?"last":"middle",-1===e.options.commands[t].showOn.indexOf(a))?!1:!0},o=function(t,e){return function(){t(e)}},n.length?t.each(n,function(i){var n,s,r,d,l,c,h;if(c=t(this),e.items[e.definition[i]]=c,c.addClass("direct-list-editor-item"),d=[],h=t("<div>").addClass("direct-list-editor-buttons direct-edit"),e.options.divClasses)for(r in e.options.divClasses)e.options.divClasses.hasOwnProperty(r)&&(d[r]=t('<div class="'+e.options.divClasses[r]+'">'),h.append(d[r]));for(n in e.options.commands)e.options.commands.hasOwnProperty(n)&&a(n,i)&&(s=t("<a>"+e.options.commands[n].caption+"</a>"),r=e.options.commands[n].div,r&&d[r]?d[r].append(s):h.append(s),l="custom-"===n.substring(0,7)?o(e.options.commands[n].action,c):e._getCommand(n,i),s.click(l));t(this).prepend(h)}):t(this.options.placeholder).appendTo(this.list).click(e._getCommand("add",0)),this.options.init&&this.options.init.call(this)},_getCommand:function(e,i){var n=this;return function(){var a;a={url:n.options.ajaxUrl||t.directEdit.fn.ajaxUrl,type:"POST",error:function(){directNotify(directTranslate("Could not save changes."))},dataType:"json",success:function(t){n.setData(t,!0)},data:{index:i,data:n.additionalData}},a.data[n.options.command[0]]=n.options.command[1]+e,t.ajax(a),n.dialog&&n.dialog.close()}},reload:function(t){this._getCommand("reload",t)()},destroy:function(){t.Widget.prototype.destroy.call(this)},isModified:function(){return this.modified||!1},getData:function(){var t={};return t.data=this.additionalData,t},setData:function(e,i){var n,a,o;if(this.modified=i||!1,o=t("<div>").appendTo("body"),e&&e.definition){e.definition&&(this.definition=e.definition),t.extend(this.additionalData,e.data),e.newItemContent&&e.newItemIdentifier&&(a=t("<div>"+e.newItemContent+"</div>").find(this.options.listSelector).children().last(),a.length||(a=t(e.newItemContent)),this.items[e.newItemIdentifier]=a,o.append(a),directEdit(a)),o.append(this.list.contents());for(n in this.definition)this.definition.hasOwnProperty(n)&&this.list.append(this.items[this.definition[n]]);o.remove(),this.options.callback&&"function"==typeof this.options.callback?this.options.callback.call(this,e.activeItem):this._init()}},setAdditionalData:function(e){this.additionalData={},t.extend(this.additionalData,e)},setAjaxUrl:function(t){this.ajaxUrl=t}})}(jQuery),function(t){"use strict";t.widget("directEdit.directLinkEditor",{additionalData:null,options:{buttonTextFollowLink:"follow link",buttonTextEditLink:"edit link",buttonTextDelete:"delete",buttonTextShow:"show",buttonTextHide:"hide",deleteCommand:["action","direct-delete-post"],hideCommand:["action","direct-hide-post"],showCommand:["action","direct-show-post"]},_create:function(){var e,i;e=this,this.element.is("a")&&(this.originalLink=this.link=this.element.attr("href"),this.element.addClass("direct-link-editor"),this.element.removeAttr("href").addClass("direct-link-editor"),i=t('<div class="direct-link-editor-buttons direct-edit">'),this.options.buttonFollowLink===!0&&(this.follow=t("<a>"+this.options.buttonTextFollowLink+"</a>").attr("href",this.link).appendTo(i)),this.options.buttonEditLink===!0&&t("<a>"+this.options.buttonTextEditLink+"</a>").appendTo(i).click(function(){return e.editLink()}),(this.options.buttonShow===!0||this.options.buttonHide===!0)&&(this.showButton=t("<a>"+this.options.buttonTextShow+"</a>").click(this.postCommand("show")).appendTo(i),this.hideButton=t("<a>"+this.options.buttonTextHide+"</a>").click(this.postCommand("hide")).appendTo(i),this.options.buttonHide!==!0&&this.hideButton.hide(),this.options.buttonShow!==!0&&this.showButton.hide()),this.options.buttonDelete===!0&&t("<a>"+this.options.buttonTextDelete+"</a>").click(this.postCommand("delete")).appendTo(i),this.element.prepend(i)),this.createDialog()},postCommand:function(e){var i=this;return function(){var n,a={};("delete"!==e||confirm("Do you really wish to delete this post?"))&&(a.data=i.additionalData,n=i.options[e+"Command"],a[n[0]]=n[1],t.ajax({url:i.options.ajaxUrl||t.directEdit.fn.ajaxUrl,type:"POST",error:function(){window.alert("Cannot perform action")},dataType:"json",success:function(t){i.updateUI(t)},data:a}))}},followLink:function(){window.location.href=this.link},editLink:function(){return this.options.notEditable!==!0?(this.dialog.dialog("open"),!1):void 0},updateUI:function(t){"addclass"===t.action?(this.showButton.show(),this.hideButton.hide(),this.element.addClass(t.cssClass)):"removeclass"===t.action?(this.hideButton.show(),this.showButton.hide(),this.element.removeClass(t.cssClass)):"delete"===t.action&&this.element.hide()},getLinkInRange:function(t){var e,i;return e=t.startContainer.parentNode,i=t.endContainer.parentNode,this.getLinkFromNode(e)||this.getLinkFromNode(i)},getLinkFromNode:function(t){var e,i=t;if(t&&i!==this.options.textContainer[0])do{if("a"===i.tagName.toLowerCase()){e=i;break}i=i.parentNode}while(i!==this.options.textContainer[0]);return e},createDialog:function(){var e,i,n,a,o,s,r,d,l,c,h,u,p,m,g=this;if(e={autoOpen:!1,width:540,title:"Edit Link",modal:!1,resizable:!1,draggable:!1,dialogClass:"direct-edit"},this.options.textContainer&&(u=function(e,i,n){var a,o=null;return"object"!=typeof e?(console.log("no range found"),void 0):(o=e.startContainer.childNodes[e.startOffset],a=g.getLinkInRange(e),i?(a?a.href=i:(p(e),document.execCommand("createlink",null,i),a=g.getLinkInRange(window.getSelection().getRangeAt(0))||g.getLinkFromNode(o)),a&&n&&(t(a).attr(n),""===n.target&&t(a).removeAttr("target"))):(a&&e.selectNode(a),p(e),document.execCommand("unlink",null,""),a=null),e.collapse(!0),p(e),t(a))},p=function(t){var e=window.getSelection();e.removeAllRanges(),e.addRange(t)}),h=function(t){return function(){c(t)}},c=function(e){g.prefix=e,"/"===e&&window.location.origin?t("span#prefix",i).html(window.location.origin+e):t("span#prefix",i).html(e)},n=function(t){return function(){var e,n;return g.link=t?"":g.prefix+a.val(),g.follow&&g.follow.attr("href",g.link),n=g.options.attributes||{},n.target="http://"===g.prefix||"https://"===g.prefix?"_blank":"",g.options.textContainer&&(e=u(m,g.link,n)),g.options.callback&&"function"==typeof g.options.callback&&g.options.callback.call(g,e),i.dialog("close"),!1}},i=t('<div><form class="linkForm"><br><br><span id="prefix">/</span><input class="url" type="text" name="url" /><input type="button" id="saveLinkButton" value="Save" /></form></div>'),this.options.textContainer&&i.find("form.linkForm").append('<input type="button" id="removeLinkButton" value="Remove" />'),this.options.prefixes){l=t("<div>").prependTo(t("form",i));for(r in this.options.prefixes)this.options.prefixes.hasOwnProperty(r)&&(d=t('<label><input type="radio" name="prefix" value="'+this.options.prefixes[r][0]+'">'+this.options.prefixes[r][1]+"</label> ").change(h(this.options.prefixes[r][0])).appendTo(l))}a=t("input[name=url]",i),o=t("input#saveLinkButton",i),s=t("input#removeLinkButton",i),a.focus(function(){this.select()}),o.click(n(!1)),s.click(n(!0)),i.dialog(e),i.bind("dialogopen",function(){var e,n,a;if(m=window.getSelection().getRangeAt(0),g.options.textContainer&&m&&(a=g.getLinkInRange(m)||g.getLinkFromNode(m.startContainer.childNodes[m.startOffset]),g.link=a?t(a).attr("href"):""),g.options.prefixes&&t('input:radio[value="'+g.options.prefixes[0][0]+'"]',i).prop("checked",!0),c("/"),n=g.link&&0===g.link.indexOf("/")?g.link.substring(1):g.link,g.options.prefixes)for(e in g.options.prefixes)g.options.prefixes.hasOwnProperty(e)&&g.link&&0===g.link.indexOf(g.options.prefixes[e][0])&&(t('input:radio[value="'+g.options.prefixes[e][0]+'"]',i).prop("checked",!0),c(g.options.prefixes[e][0]),n=g.link.substring(g.prefix.length));t("input[name=url]",i).val(n)}),this.dialog=i},getDialog:function(){return this.dialog},isModified:function(){return this.originalLink!==this.link},getData:function(){var t={};return t.link=this.link,t.data=this.additionalData,t},setData:function(e){this.link=e.url,t.extend(this.additionalData,e.data),this.originalLink=this.link},setAdditionalData:function(t){this.additionalData=t}})}(jQuery),function(t){"use strict";t.widget("directEdit.directDateEditor",{additionalData:null,options:{format:"MM dd yy"},_create:function(){var e=this;this.dateOld=this.dateNew=this.element.attr("data-date").substring(0,10),this.input=t('<input value="'+this.dateOld+'" />').css({visibility:"hidden",position:"absolute"}).insertAfter(this.element),this.input.datepicker({dateFormat:"yy-mm-dd",onSelect:function(i){e.dateNew=i,e.element.html(t.datepicker.formatDate(e.options.format,new Date(i)))}}),this.element.click(function(){e.input.datepicker("show")})},isModified:function(){return this.dateOld!==this.dateNew},getData:function(){var t={};return t.content=this.dateNew+" 00:00:00",t.data=this.additionalData,t},setData:function(e){this.dateNew=this.dateOld=e.content.substring(0,10),this.input.datepicker("setDate",this.dateNew),this.element.html(t.datepicker.formatDate(this.options.format,new Date(this.dateNew))),t.extend(this.additionalData,e.data)},setAdditionalData:function(t){delete t.date,delete t["date-datepicker"],this.additionalData=t}})}(jQuery);var directEditMenu,directMenuSaveButton;!function(t){"use strict";directEditMenu=function(e){var i,n;i=e.selectionPath;var a=[],o=function(t){var e,i,n,o,s="";s+='<div class="direct-menu-trash">trash</div>',s+='<div class="direct-menu-accordion">';for(e in t){s+="<h3>"+t[e].name+"</h3>",-1===a.indexOf(t[e])&&a.push(t[e]),o=a.indexOf(t[e]),n=t[e].items,s+="<ul>";for(i in n)s+='<li data-remove-from-parent="false" data-parent-reference="'+o+'" data-index="'+i+'"><a>'+n[i].name+"</a></li>";s+="</ul>"}return s+="</div>"};t(".direct-menu-new-items").html(o(e["new"])),t(".direct-menu-new-items li").draggable({helper:"clone",connectToSortable:".direct-menu-sortable"}),t(".direct-menu-accordion").accordion(),n=function(){var o;o=a.slice(0),jQuery(".direct-editable-menu").each(function(){var n,a;n=t(this),a=JSON.parse(n.attr("data-local-options")),a.classSelected="menu-item-active";var s=function(t,e,n,r,d,l){var c,h,u,p="";if(d=d||0,-1===o.indexOf(t[e])&&o.push(t[e]),c=o.indexOf(t[e]),t=t[e].items,l=l?l+","+e:"&quot;"+e+"&quot;",n>d)d+1<i.length&&(e=i[d+1]),void 0!==e&&t&&t[e]&&(p=s(t,e,n,r,d+1,l));else{t&&t.length>0?h='class="direct-menu-sortable" ':d+1===i.length&&(h='class="direct-menu-droppable" ',u='<li class="direct-menu-placeholder"><a>new</a></li>'),p+="<ul "+h+'data-path="'+l+'"data-reference="'+c+'">',u&&(p+=u);for(e in t){var m="";e==i[d+1]&&(m=' class="'+a.classSelected+'"'),p+="<li"+m+' data-remove-from-parent="true" data-path="'+l+","+e+'"data-parent-reference="'+c+'" data-index="'+e+'">',p+="<a>"+t[e].name+"</a>",(0===r||-1===r||void 0===r||n+r-1>d)&&(p+=s(t,e,n,r,d+1,l)),p+="</li>"}p+="</ul>"}return p};n.html(s(e.menus,a.menu,a.startLevel,a.depth))}),t(".direct-menu-sortable").sortable({connectWith:".direct-menu-sortable",stop:function(t,e){var i,a,s,r,d;i=o[e.item.attr("data-parent-reference")],a=e.item.attr("data-index"),d=i.items[a],"true"===e.item.attr("data-remove-from-parent")&&i.items.splice(a,1),s=e.item.index(),r=o[e.item.parent().attr("data-reference")],d&&r.items.splice(s,0,d),e.item.attr("data-path",e.item.parent().attr("data-path")+","+s),n()}}),t(".direct-editable-menu li").click(function(){t(this).attr("data-path")&&(i=JSON.parse("["+t(this).attr("data-path")+"]"),n())}),t(".direct-menu-droppable").droppable({hoverClass:"drop-hover",drop:function(e,i){var a,s,r,d;a=o[i.draggable.attr("data-parent-reference")],s=i.draggable.attr("data-index"),r=a.items[s],d=o[t(this).attr("data-reference")],d.items=[r],n()}}),t(".direct-menu-trash").droppable({hoverClass:"drop-hover",drop:function(t,e){var i,a;i=o[e.draggable.attr("data-parent-reference")],a=e.draggable.attr("data-index"),"true"===e.draggable.attr("data-remove-from-parent")&&i.items.splice(a,1),n()}})},n(),t.fn.directMenuSaveButton=function(){var i={};i.action="direct-save-menu",i.menus=e.menus,t(this).click(function(){t.ajax({url:e.ajaxUrl,type:"POST",error:function(){alert("Error saving.")},dataType:"json",success:function(){alert("A miracle just happened.")},data:i})})}}}(jQuery);var directEdit,directNotify,directTranslate;!function(t){"use strict";t.directEdit.fn={editors:{},counter:0,globalOptions:{},ajaxUrl:"",getData:function(e){var i={},n=/^data\-([a-z0-9\-]+)$/;return t.each(e.get(0).attributes,function(t,e){if(n.test(e.nodeName)&&"data-global-options"!==e.nodeName&&"data-local-options"!==e.nodeName){var a=e.nodeName.match(n)[1];i[a]=e.value}}),i},notify:function(e){var i,n,a;a=t("#direct-notify-container"),a.length||(a=t("<div>").attr("id","direct-notify-container"),t("body").append(a)),n=function(e){return function(){e.animate({opacity:"0",height:"0px"},{duration:"slow",complete:function(){t(this).remove()}})}},i=t("<div><p>"+e+"</p></div>").addClass("notify").hide().fadeIn("slow"),a.append(i),setTimeout(n(i),3500)},directEdit:function(e){function i(e){var i,a,o,s,r,d,l,c,h;if(i=e.attr("data-global-options"),i&&n.globalOptions){switch(a={},"page-options"===i?r="options":(o=n.globalOptions[i],e.attr("data-local-options")&&(s=JSON.parse(e.attr("data-local-options"))||{}),t.extend(!0,a,o,s),r=a.type,l=n.getData(e)),r){case"text":h=e.closest("a"),1===h.length?h.directLinkEditor({buttonFollowLink:!0}):a.unwrap&&(d=e.parent(),d.html(e.html()),e=d),a.instanceID=n.counter,e.directTextEditor(a),c=e.data("directEdit-directTextEditor");break;case"file":e.directFileUploader(a),c=e.data("directEdit-directFileUploader");break;case"image":h=e.closest("a"),1===h.length&&h.directLinkEditor({buttonFollowLink:!0}),e.directImageEditor(a),c=e.data("directEdit-directImageEditor");break;case"link":e.directLinkEditor(a),c=e.data("directEdit-directLinkEditor");break;case"list":e.directListEditor(a),c=e.data("directEdit-directListEditor");break;case"date":e.directDateEditor(a),c=e.data("directEdit-directDateEditor");break;case"options":e.directPageOptions(a),c=e.data("directEdit-directPageOptions")}c&&("options"===r?n.editors["direct-page-options"]=c:(c.setAdditionalData(l),n.editors["editor-"+n.counter]=c),n.counter+=1)}}var n=t.directEdit.fn;"object"==typeof e&&(e instanceof jQuery?e.find(".direct-editable").each(function(){i(jQuery(this))}):(n.globalOptions=e,jQuery(".direct-editable").each(function(){i(jQuery(this))})))},taskCount:function(){var t,e,i=0;for(t in this.editors)this.editors.hasOwnProperty(t)&&(e=this.editors[t],e.isModified()&&(i+=1));return i},saveAll:function(){var e,i,n={},a=0,o="",s=this;for(e in this.editors)this.editors.hasOwnProperty(e)&&(i=this.editors[e],(i.options.alwaysSave||("function"==typeof i.isTouched?i.isTouched():i.isModified()))&&(n[e]=i.getData(),a+=1));n[this.command[0]]=this.command[1],a?t.ajax({url:this.ajaxUrl,type:"POST",error:function(){s.notify(directTranslate("Error saving."))},dataType:"json",success:function(e){var i,n,r=0;if("object"==typeof e){if(e.redirect)return t(window).off("beforeunload"),window.location.replace(e.redirect),void 0;for(i in s.editors)s.editors.hasOwnProperty(i)&&e.hasOwnProperty(i)&&(n=s.editors[i].setData(e[i]),n&&(s.editors[i]=n),r+=1)}o=r===a?directTranslate("The page has been saved."):directTranslate("Error. Not everything could be saved.")+" ("+r+"/"+a+" "+directTranslate("saved.")+")",s.notify(o)},data:n}):(o=directTranslate("Nothing to save."),this.notify(o))}},t.fn.directSaveButton=function(e){function i(t){var e,i={},n=/[?&]?([^=]+)=([^&]*)/g;for(t=t.split("+").join(" ");e=n.exec(t);)i[decodeURIComponent(e[1])]=decodeURIComponent(e[2]);return i}e&&(t.directEdit.fn.ajaxUrl=e.ajaxUrl||"",t.directEdit.fn.command=e.command||["action","direct-save-page"]),this.click(function(){return t.directEdit.fn.saveAll(),!1});var n=i(document.location.search);"saved"===n.de_message&&directNotify(directTranslate("The page has been saved."))},setInterval(function(){t.post(t.directEdit.fn.ajaxUrl)},6e5),t(window).on("beforeunload",function(){return t.directEdit.fn.taskCount()>0?"De page has been changed, do you really want to leave the page?":void 0}),t.widget("directEdit.directPageOptions",{options:{},_create:function(){var e,i,n;n=this,e=function(){return function(){return n.element.dialog({title:"Page options",modal:!0,width:800,dialogClass:"direct-edit"}),!1}}(),i=function(){return function(){return n.modified=!0,t.directEdit.fn.saveAll(),!1}}(),t.fn.directOptionButton=function(){t(this).click(e)},this.createCategoryEditor(),this.element.find("input[type=submit]").click(i),this.element.hide()},createCategoryEditor:function(){var e,i,n,a,o,s,r,d,l,c,h,u,p;if(h=function(){var e,o,r;o=n.val(),r="",a=[],s.find("li").each(function(){var i;i=function(t){return o===t?' selected="selected"':""},e={},e.id=t(this).attr("id"),e.name=t(this).find(".title-input").val(),r+='<option value="'+e.id+'"'+i(e.id)+">"+e.name+"</option>",a.push(e)}),n.html(r),i.val(JSON.stringify(a))},c=function(){s.find("li").each(function(){var e,i;e=t(this).find(".title"),i=t(this).find(".title-input"),e.html(i.val()||'<span style="color:grey;">New category</span>'),e.show(),i.hide()}),t("html").unbind("click"),t(document).unbind("keypress"),h()},d=function(e){return function(){var i,n;i=e.find(".title").hide(),n=e.find(".title-input").show(),n.click(function(t){t.stopPropagation()}),t("html").click(c),t(document).keypress(function(t){13===t.which&&c()})}},u=function(t){return function(){t.remove(),c()}},p=function(e,i){var n,a,o;i||(i="new-"+l,l+=1),o=t('<li id="'+i+'"><input class="title-input somewidth" value="'+e+'" style="display:none;"></li>'),a=t('<span class="title somewidth">'+e+"</span>"),a.dblclick(d(o)),n=t('<a class="pointer">delete</a>'),n.click(u(o)),o.append(a).append(n),s.append(o)},i=t("#categoryInput"),i&&i.val()){for(a=jQuery.parseJSON(i.val()),l=0,e=t("#categoryEditor"),n=t(i[0].form).find('[name="de_category"]'),s=t("<ul>").appendTo(e),o=0;o<a.length;o+=1)p(a[o].name,a[o].id);r=t('<a class="pointer add-new">add new</a>'),r.click(function(){p("",""),c()}),t("<div>").append(r).insertAfter(s)}},isModified:function(){return this.modified===!0},getData:function(){return this.element.find("form").serializeObject()},setData:function(){this.modified=!1}}),t.fn.serializeObject=function(){var t={},e=this.serializeArray();return jQuery.each(e,function(){void 0!==t[this.name]?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(this.value||"")):t[this.name]=this.value||""}),t},directNotify=t.directEdit.fn.notify,directEdit=t.directEdit.fn.directEdit,directTranslate=function(t){var e;return"object"==typeof directTranslations&&(e=directTranslations[t],e||console.log("not translated yet: "+t)),e||t}}(jQuery);